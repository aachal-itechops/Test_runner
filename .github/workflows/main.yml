name: "ðŸšš Manual Backend/Frontend Dry-Run Deploy"

on:
  workflow_dispatch:
    inputs:
      host:
        description: "Select target host / runner"
        required: true
        type: choice
        options:
          - host24-backend
          - host24-frontend
          - host24-zip
          - AWS_Staging
          - AWS_PROD_01
          - AWS_PROD_02
          - AWS_PROD_03
          - AWS_PROD_04
          - AWS_PROD_05
          - DESKTOP-Q4SDOI5

      domain:
        description: "Comma-separated domain(s). Required."
        required: false

      exclude_domains:
        description: "Comma-separated domains to exclude manually"
        required: false

      restart_iis:
        description: "Restart IIS before & after Deployment?"
        required: false
        type: boolean

      app_type:
        description: "Deployment Type (backend -> AG, frontend -> httpdocs, both)"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both

      # For dry-run, release_tag is not used, but kept for compatibility
      release_tag:
        description: "GitHub Release tag (e.g., release/V10.0.3)"
        required: false

permissions:
  contents: read

jobs:
  deploy:
      runs-on: [self-hosted, DESKTOP-Q4SDOI5, Windows]
   # runs-on: ${{ fromJson('{"host24-backend":["self-hosted","Windows","X64","host24","backend"],"host24-frontend":["self-hosted","Windows","X64","host24","frontend"],"host24-zip":["self-hosted","Windows","X64","host24","zip"],"AWS_Staging":["self-hosted","Windows","X64","AWS_Staging"],"AWS_PROD_01":["self-hosted","Windows","X64","AWS_PROD_01"],"AWS_PROD_02":["self-hosted","Windows","X64","AWS_PROD_02"],"AWS_PROD_03":["self-hosted","Windows","X64","AWS_PROD_03"],"AWS_PROD_04":["self-hosted","Windows","X64","AWS_PROD_04"],"AWS_PROD_05":["self-hosted","Windows","X64","AWS_PROD_05"]}')[github.event.inputs.host] }}
      
      steps:

      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      # Commented GitHub CLI / Release download for local dry-run
      # - name: "âš™ï¸ Ensure GitHub CLI Installed (ZIP fallback)"
      #   shell: pwsh
      #   run: |
      #     if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
      #       Write-Host "ðŸ“¦ Installing GitHub CLI (ZIP fallback)..."
      #       $version = "2.56.0"
      #       $url = "https://github.com/cli/cli/releases/download/v$version/gh_${version}_windows_amd64.zip"
      #       $zip = "$env:TEMP\ghcli.zip"
      #       $dest = "$env:ProgramData\ghcli"
      #       if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
      #       Invoke-WebRequest -Uri $url -OutFile $zip
      #       Expand-Archive $zip $dest -Force
      #       $exe = Get-ChildItem $dest -Recurse -Filter gh.exe | Select-Object -First 1
      #       if (-not $exe) { Write-Error "âŒ gh.exe missing"; exit 1 }
      #       echo $exe.DirectoryName | Out-File $env:GITHUB_PATH -Append
      #       & "$($exe.FullName)" --version
      #     } else {
      #       Write-Host "âœ… GH CLI exists: $(gh --version | Select-String 'gh version')"
      #     }

      # - name: "ðŸ§¾ Download ZIP Assets from GitHub Release"
      #   id: download
      #   shell: pwsh
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     $tag="${{ github.event.inputs.release_tag }}"
      #     Write-Host "ðŸ“¥ Downloading Release ZIPs for $tag..."
      #     gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --clobber
      #     $downloadDir="$PWD/release_zips"
      #     if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
      #     New-Item -ItemType Directory -Path $downloadDir | Out-Null
      #     Move-Item *.zip $downloadDir -Force
      #     $count=(Get-ChildItem $downloadDir "*.zip").Count
      #     if ($count -eq 0) { Write-Error "âŒ No ZIP files found"; exit 1 }
      #     echo "download_dir=$downloadDir" >> $env:GITHUB_OUTPUT

      - name: "ðŸ“¦ Extract and Merge Local ZIPs (Dry-Run)"
        id: extract
        shell: pwsh
        run: |
          # For local dry-run, set the folder where frontend.zip and backend.zip exist
          $src="C:\local_zips"  # <-- put your frontend.zip & backend.zip here
          $root="$PWD/deploy"

          if (Test-Path $root) { Remove-Item -Recurse -Force $root }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged=Join-Path $root "merged"
          New-Item -ItemType Directory $merged | Out-Null

          foreach ($zip in Get-ChildItem $src "*.zip") {
            Write-Host "ðŸ“¦ Found ZIP: $($zip.Name)"
            $tmp=Join-Path $root $zip.BaseName
            Expand-Archive $zip.FullName $tmp -Force
            Get-ChildItem $tmp | ForEach-Object {
              # Dry-run: just show which files would be copied
              Write-Host "  âœ… Would copy: $($_.FullName) -> $merged"
              # Copy-Item $_.FullName -Destination $merged -Recurse -Force  # Commented for dry-run
            }
          }

          echo "extract_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "ðŸš€ Dry-Run Deploy to Domain(s)"
        id: deploy
        shell: pwsh
        run: |
          $type="${{ github.event.inputs.app_type }}"
          $success=@()
          $failed=@()

          switch ($type) {
            "frontend" { $targets = @("C:\dryrun\httpdocs") }
            "backend"  { $targets = @("C:\dryrun\httpdocs\AG") }
            "both"     { $targets = @("C:\dryrun\httpdocs","C:\dryrun\httpdocs\AG") }
          }

          foreach ($target in $targets) {
            Write-Host "ðŸ“‚ Would deploy to: $target from ${{ steps.extract.outputs.extract_root }}"
            $success += $target
          }

          Write-Host "`nâœ… Dry-run complete. Targets:"
          $success | ForEach-Object { Write-Host "  $_" }

      - name: "ðŸ§¹ Cleanup workspace"
        if: always()
        shell: pwsh
        run: |
          # Dry-run: keep files, just show cleanup message
          Write-Host "ðŸ§¹ Cleanup completed (dry-run, files preserved)."
