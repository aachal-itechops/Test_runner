name: "üöö Manual Local Deploy Test"

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: "üì• Checkout Repo"
        uses: actions/checkout@v4

      - name: "üöÄ Content-Based Deploy from ZIPs"
        shell: pwsh
        run: |
          $sourceFolder = "C:\deploy_test\source"
          $destRoot     = "C:\deploy_test\destination\httpdocs"

          # Destination folders (auto-create if missing)
          $folders = @("AG","CREW","EInvoice","EProposal","EStatement")
          foreach ($f in $folders) {
              $path = Join-Path $destRoot $f
              if (-not (Test-Path $path)) {
                  New-Item -Path $path -ItemType Directory -Force | Out-Null
              }
          }

          # Process every .zip file
          $zipFiles = Get-ChildItem $sourceFolder -Filter "*.zip"

          foreach ($zip in $zipFiles) {

              Write-Host "`nüì¶ Processing ZIP: $($zip.Name)"

              # Create temp extraction folder
              $temp = Join-Path $env:RUNNER_TEMP ("z_" + [guid]::NewGuid().ToString())
              New-Item -Path $temp -ItemType Directory | Out-Null

              # Extract ZIP
              Expand-Archive -Path $zip.FullName -DestinationPath $temp -Force

              # Scan extracted content
              $allItems = Get-ChildItem -Path $temp -Recurse | Select-Object -ExpandProperty FullName

              # Determine destination by content
              $destination = ""

              if ($allItems -match "ag") {
                  $destination = "AG"
              }
              elseif ($allItems -match "crew") {
                  $destination = "CREW"
              }
              elseif ($allItems -match "e-?invoice") {
                  $destination = "EInvoice"
              }
              elseif ($allItems -match "e-?proposal") {
                  $destination = "EProposal"
              }
              elseif ($allItems -match "e-?statement") {
                  $destination = "EStatement"
              }
              else {
                  Write-Warning "‚ö†Ô∏è No matching keyword found in ZIP content. Skipping: $($zip.Name)"
                  continue
              }

              $destPath = Join-Path $destRoot $destination
              Write-Host "üìÇ Detected ‚Üí $destination"
              Write-Host "üì• Copying content to $destPath"

              # Copy extracted files to destination
              Copy-Item "$temp\*" $destPath -Recurse -Force

              # Cleanup temp folder
              Remove-Item $temp -Recurse -Force -ErrorAction SilentlyContinue
          }

      - name: "üßπ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleanup completed."
