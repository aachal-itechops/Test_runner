name: "ðŸšš Manual Local Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false
      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  # -------------------------------
  # 1. Extract ZIPs
  # -------------------------------
  extract:
    runs-on: [self-hosted]
    outputs:
      merged_root: ${{ steps.extract.outputs.merged_root }}
    steps:
      - name: "ðŸ“¥ Checkout Repo"
        uses: actions/checkout@v4

      - name: "ðŸ“¦ Extract ZIPs"
        id: extract
        shell: pwsh
        run: |
          $root = "$PWD/deploy"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null

          $sourceFolder = "C:\deploy_test\source"
          $zipFiles = Get-ChildItem -Path $sourceFolder -Filter *.zip*

          foreach ($zip in $zipFiles) {
              $temp = Join-Path $root ("extract_" + [System.IO.Path]::GetFileNameWithoutExtension($zip.Name))
              New-Item -ItemType Directory -Path $temp | Out-Null
              Write-Host "ðŸŸ© Extracting $($zip.Name)"
              Expand-Archive -LiteralPath $zip.FullName -DestinationPath $temp -Force
          }

          echo "merged_root=$root" >> $env:GITHUB_OUTPUT

  # -------------------------------
  # 2. Deploy Extracted Files
  # -------------------------------
  deploy:
    runs-on: [self-hosted]
    needs: extract
    steps:
      - name: "ðŸš€ Deploy Extracted Files"
        shell: pwsh
        run: |
          $sourceRoot = "${{ needs.extract.outputs.merged_root }}"
          $destinationRoot = "C:\deploy_test\destination\httpdocs"
          $domains = "${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $deployType = "${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {
              Write-Host "`nâž¡ Deploying to domain: $domain"

              $folders = Get-ChildItem -Path $sourceRoot -Directory

              foreach ($folder in $folders) {
                  switch -Regex ($folder.Name) {
                      "crew"        { $dest = Join-Path $destinationRoot "CREW"; if ($deployType -eq "backend") { continue } }
                      "v10|ag-app"  { $dest = Join-Path $destinationRoot "AG"; if ($deployType -eq "frontend") { continue } }
                      "e-invoice"   { $dest = Join-Path $destinationRoot "EInvoice" }
                      "e-statement" { $dest = Join-Path $destinationRoot "EStatement" }
                      "e-proposal"  { $dest = Join-Path $destinationRoot "EProposal" }
                      default       { Write-Host "âš  Unknown folder: $($folder.Name)"; continue }
                  }

                  Write-Host "ðŸ“‚ Deploying $($folder.Name) â†’ $dest"
                  if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }
                  Remove-Item "$dest\*" -Recurse -Force -ErrorAction SilentlyContinue
                  Copy-Item "$($folder.FullName)\*" $dest -Recurse -Force
              }
          }

      - name: "ðŸ§¹ Cleanup Deploy Folder"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
