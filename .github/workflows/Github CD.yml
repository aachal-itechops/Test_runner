name: "ðŸšš Manual Backend/Frontend Deploy"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domain(s)"
        required: false
      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:

      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ“‚ Prepare merge folder from manual frontend/backend"
        shell: pwsh
        id: merge
        run: |
          $root = "$PWD/deploy"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged = "$root/merged"
          New-Item -ItemType Directory -Path $merged | Out-Null

          # Create frontend/backend inside merge folder
          New-Item -ItemType Directory -Path "$merged/frontend" | Out-Null
          New-Item -ItemType Directory -Path "$merged/backend"  | Out-Null

          # Copy manual files from local folders
          $frontendSrc = "C:\deploy_test\frontend"
          $backendSrc  = "C:\deploy_test\backend"

          if (-not (Test-Path $frontendSrc)) { Write-Error "âŒ frontend folder missing"; exit 1 }
          if (-not (Test-Path $backendSrc))  { Write-Error "âŒ backend folder missing"; exit 1 }

          Copy-Item "$frontendSrc\*" "$merged/frontend" -Recurse -Force
          Copy-Item "$backendSrc\*"  "$merged/backend"  -Recurse -Force

          echo "merged_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "ðŸš€ Deploy merged files (frontend/backend/both)"
        shell: pwsh
        run: |
          Import-Module WebAdministration

          $source = "${{ steps.merge.outputs.merged_root }}"
          $domains = "${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $type = "${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {

              Write-Host "`nâž¡ Deploying to $domain"

              $httpdocs   = "D:\inetpub\vhosts\$domain\httpdocs"
              $httpdocsAG = "D:\inetpub\vhosts\$domain\httpdocs\AG"

              # Build targets array like old pipeline
              $targets = @()

              switch ($type) {
                  "frontend" {
                      $targets += @{
                          Source      = Join-Path $source "frontend"
                          Destination = $httpdocs
                      }
                  }
                  "backend" {
                      $targets += @{
                          Source      = Join-Path $source "backend"
                          Destination = $httpdocsAG
                      }
                  }
                  "both" {
                      $targets += @{
                          Source      = Join-Path $source "frontend"
                          Destination = $httpdocs
                      }
                      $targets += @{
                          Source      = Join-Path $source "backend"
                          Destination = $httpdocsAG
                      }
                  }
              }

              # Deploy each target
              foreach ($t in $targets) {
                  $src = $t.Source
                  $dst = $t.Destination

                  Write-Host "ðŸ“‚ Copying from: $src â†’ $dst"

                  if (!(Test-Path $dst)) {
                      New-Item -ItemType Directory -Force -Path $dst | Out-Null
                  }

                  Copy-Item "$src\*" $dst -Recurse -Force
              }
          }

      - name: "ðŸ§¹ Cleanup workspace"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "ðŸ§¹ Cleanup completed."
