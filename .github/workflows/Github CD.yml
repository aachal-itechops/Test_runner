name: "ðŸšš Manual Backend/Frontend Deploy (Hybrid)"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false
      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both
      release_tag:
        description: "GitHub Release tag"
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Ensure GH CLI"
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "âš ï¸ GH CLI not found. Install it before running."
            exit 1
          }

      - name: "ðŸ§¾ Download ZIP Assets"
        id: download
        shell: pwsh
        run: |
          $tag="${{ github.event.inputs.release_tag }}"
          $downloadDir="$PWD/release_zips"

          if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
          New-Item -ItemType Directory -Path $downloadDir | Out-Null

          gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --clobber
          Move-Item *.zip $downloadDir -Force

          echo "download_dir=$downloadDir" >> $env:GITHUB_OUTPUT

      - name: "ðŸ“¦ Extract and Merge ZIPs"
        id: extract
        shell: pwsh
        run: |
          $src="${{ steps.download.outputs.download_dir }}"
          $root="$PWD/deploy"

          if (Test-Path $root) { Remove-Item -Recurse -Force $root }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged=Join-Path $root "merged"
          New-Item -ItemType Directory -Path $merged | Out-Null

          # Create frontend/backend inside merge
          New-Item -ItemType Directory -Path "$merged/frontend" | Out-Null
          New-Item -ItemType Directory -Path "$merged/backend" | Out-Null

          foreach ($zip in Get-ChildItem $src "*.zip") {
            $tmp=Join-Path $root $zip.BaseName
            Expand-Archive $zip.FullName $tmp -Force

            # Move frontend/backend content to correct folder in merge
            if (Test-Path "$tmp/frontend") { Copy-Item "$tmp/frontend/*" "$merged/frontend" -Recurse -Force }
            if (Test-Path "$tmp/backend")  { Copy-Item "$tmp/backend/*" "$merged/backend" -Recurse -Force }
          }

          echo "merged_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "ðŸš€ Deploy to Domains"
        shell: pwsh
        run: |
          $source="${{ steps.extract.outputs.merged_root }}"
          $domains="${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $type="${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {
            Write-Host "âž¡ Deploying to $domain"

            $targets=@()

            switch ($type) {
              "frontend" { 
                $targets+= @{ Source = "$source\frontend"; Destination = "D:\inetpub\vhosts\$domain\httpdocs" }
              }
              "backend" { 
                $targets+= @{ Source = "$source\backend"; Destination = "D:\inetpub\vhosts\$domain\httpdocs\AG" }
              }
              "both" {
                $targets+= @{ Source = "$source\frontend"; Destination = "D:\inetpub\vhosts\$domain\httpdocs" }
                $targets+= @{ Source = "$source\backend"; Destination = "D:\inetpub\vhosts\$domain\httpdocs\AG" }
              }
            }

            foreach ($target in $targets) {
              Write-Host "ðŸ“‚ Deploying from $($target.Source) â†’ $($target.Destination)"
              if (-not (Test-Path $target.Destination)) { New-Item -ItemType Directory -Path $target.Destination -Force | Out-Null }
              Copy-Item "$($target.Source)\*" $target.Destination -Recurse -Force
            }
          }

      - name: "ðŸ§¹ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
