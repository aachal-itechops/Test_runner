name: "ðŸšš Manual Local/Release Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false

      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

      release_tag:
        description: "GitHub Release tag (optional)"
        required: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: "ðŸ“¥ Checkout Repo"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Prepare frontend/backend"
        id: prepare
        shell: pwsh
        run: |
          if (${{ github.event.inputs.release_tag }}) {
              $downloadDir = "$PWD/release_zips"
              if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
              New-Item -ItemType Directory -Path $downloadDir | Out-Null

              Write-Host "ðŸ“¥ Downloading release $(${{ github.event.inputs.release_tag }})"
              gh release download ${{ github.event.inputs.release_tag }} --repo ${{ github.repository }} --pattern "*.zip" --clobber
              Move-Item *.zip $downloadDir -Force

              $frontendSrc = "$PWD/deploy/frontend"
              $backendSrc  = "$PWD/deploy/backend"

              if (Test-Path "$PWD/deploy") { Remove-Item "$PWD/deploy" -Recurse -Force }
              New-Item -ItemType Directory -Path "$PWD/deploy" | Out-Null

              foreach ($zip in Get-ChildItem $downloadDir "*.zip") {
                  $tmp = "$PWD/deploy/$($zip.BaseName)"
                  Expand-Archive $zip.FullName $tmp -Force
                  # Move frontend/backend into separate folders
                  if (Test-Path "$tmp/frontend") { Copy-Item "$tmp/frontend/*" $frontendSrc -Recurse -Force }
                  if (Test-Path "$tmp/backend")  { Copy-Item "$tmp/backend/*"  $backendSrc -Recurse -Force }
              }
          } else {
              # Local manual folders
              $frontendSrc = "C:\deploy_test\frontend"
              $backendSrc  = "C:\deploy_test\backend"
          }

          if (-not (Test-Path $frontendSrc)) { Write-Error "âŒ frontend folder missing"; exit 1 }
          if (-not (Test-Path $backendSrc))  { Write-Error "âŒ backend folder missing"; exit 1 }

          echo "frontend_src=$frontendSrc" >> $env:GITHUB_OUTPUT
          echo "backend_src=$backendSrc" >> $env:GITHUB_OUTPUT

      - name: "ðŸ“¦ Create Merge Folder"
        id: merge
        shell: pwsh
        run: |
          $root = "$PWD/deploy/merged"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null

          New-Item -ItemType Directory -Path "$root/frontend" | Out-Null
          New-Item -ItemType Directory -Path "$root/backend" | Out-Null

          Copy-Item "${{ steps.prepare.outputs.frontend_src }}\*" "$root/frontend" -Recurse -Force
          Copy-Item "${{ steps.prepare.outputs.backend_src }}\*" "$root/backend" -Recurse -Force

          echo "merged_root=$root" >> $env:GITHUB_OUTPUT

      - name: "ðŸš€ Deploy using targets"
        shell: pwsh
        run: |
          $source="${{ steps.merge.outputs.merged_root }}"
          $domains="${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $type="${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {
            Write-Host "âž¡ Deploying to $domain"

            $targets = @()
            switch ($type) {
              "frontend" { $targets += @{ Source = "$source\frontend"; Destination = "D:\inetpub\vhosts\$domain\httpdocs" } }
              "backend"  { $targets += @{ Source = "$source\backend";  Destination = "D:\inetpub\vhosts\$domain\httpdocs\AG" } }
              "both"     { 
                  $targets += @{ Source = "$source\frontend"; Destination = "D:\inetpub\vhosts\$domain\httpdocs" }
                  $targets += @{ Source = "$source\backend";  Destination = "D:\inetpub\vhosts\$domain\httpdocs\AG" }
              }
            }

            foreach ($target in $targets) {
              Write-Host "ðŸ“‚ Deploying from $($target.Source) â†’ $($target.Destination)"
              if (-not (Test-Path $target.Destination)) {
                  New-Item -ItemType Directory -Path $target.Destination -Force | Out-Null
              }
              Copy-Item "$($target.Source)\*" $target.Destination -Recurse -Force
            }
          }

      - name: "ðŸ§¹ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD/release_zips" -Recurse -Force -ErrorAction SilentlyContinue
