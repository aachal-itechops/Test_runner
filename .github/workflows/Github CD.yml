name: "üöö Manual Local Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: true
      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: "üì• Checkout Repo"
        uses: actions/checkout@v4

      - name: "üì¶ Prepare Merge Folder"
        id: prep
        shell: pwsh
        run: |
          $root = "$PWD/deploy"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null
          echo "root=$root" >> $env:GITHUB_OUTPUT

      - name: "üì¶ Extract ZIPs"
        id: extract
        shell: pwsh
        run: |
          $sourceFolder = "C:\deploy_test\source"
          $extractRoot  = "${{ steps.prep.outputs.root }}"
          $deployType   = "${{ github.event.inputs.app_type }}"
          $zipFiles = Get-ChildItem $sourceFolder -Filter *.zip*

          foreach ($zip in $zipFiles) {
              $isBackend  = $zip.Name -match "v10"
              $isFrontend = $zip.Name -match "ag-app|crew|e-invoice|e-statement|e-proposal"

              if ($deployType -eq "backend" -and -not $isBackend) { continue }
              if ($deployType -eq "frontend" -and -not $isFrontend) { continue }

              $folderName = [System.IO.Path]::GetFileNameWithoutExtension($zip.Name)
              $target = Join-Path $extractRoot $folderName

              New-Item -ItemType Directory -Path $target -Force | Out-Null
              Write-Host "üü© Extracting $($zip.Name) ‚Üí $target"
              Expand-Archive -Path $zip.FullName -DestinationPath $target -Force
          }

          echo "extract_root=$extractRoot" >> $env:GITHUB_OUTPUT

      - name: "üöÄ Deploy Extracted Folders"
        shell: pwsh
        run: |
          $srcRoot = "${{ steps.extract.outputs.extract_root }}"
          $domains = "${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $deployType = "${{ github.event.inputs.app_type }}"

          # Deployment maps
          $frontendMap = @{
              "ag-app"      = "AG"
              "crew"        = "CREW"
              "e-proposal"  = "EProposal"
              "e-invoice"   = "EInvoice"
              "e-statement" = "EStatement"
          }

          $backendMap = @{
              "v10" = "AG"
          }

          switch ($deployType) {
              "frontend" { $deployMap = $frontendMap }
              "backend"  { $deployMap = $backendMap }
              "both"     { $deployMap = $frontendMap + $backendMap }
          }

          foreach ($domain in $domains) {
              Write-Host "`nüåç Deploying domain: $domain"

              foreach ($key in $deployMap.Keys) {

                  # Source folder is extracted folder name that contains key
                  $src = Get-ChildItem -Path $srcRoot -Directory | Where-Object { $_.Name -match $key }

                  if (-not $src) {
                      Write-Warning "‚ö†Ô∏è Cannot find extracted folder for: $key ‚Äî skipping"
                      continue
                  }

                  $srcPath = $src.FullName
                  $targetPath = "C:\deploy_test\destination\httpdocs\$($deployMap[$key])"

                  if (-not (Test-Path $targetPath)) {
                      Write-Host "üìÅ Creating $targetPath ..."
                      New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
                  }

                  Write-Host "üöö Copying $key ‚Üí $targetPath ..."
                  Copy-Item "$srcPath\*" -Destination $targetPath -Recurse -Force
                  Write-Host "‚úÖ $key deployed successfully."
              }
          }

      - name: "üßπ Cleanup Deploy Folder"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
