name: "üöö Manual Local Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false

      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout Repo
      # -----------------------------
      - name: "üì• Checkout Repo"
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è‚É£ Extract ZIPs to merged folder
      # -----------------------------
      - name: "üì¶ Extract ZIPs"
        id: extract
        shell: pwsh
        run: |
          $sourceFolder = "C:\deploy_test\source"
          $merged = "$PWD/deploy/merged"

          # Clean merged folder
          if (Test-Path $merged) { Remove-Item $merged -Recurse -Force }
          New-Item -ItemType Directory -Path $merged | Out-Null

          # Extract all ZIPs to merged folder
          $zipFiles = Get-ChildItem -Path $sourceFolder -Filter *.zip*
          foreach ($zip in $zipFiles) {
              $temp = Join-Path $merged "extract_$((Get-Random))"
              New-Item -ItemType Directory -Path $temp | Out-Null
              Write-Host "üü© Extracting $($zip.Name)"
              Expand-Archive -LiteralPath $zip.FullName -DestinationPath $temp -Force
          }

          echo "merged_root=$merged" >> $env:GITHUB_OUTPUT

      # -----------------------------
      # 3Ô∏è‚É£ Deploy extracted folders
      # -----------------------------
      - name: "üöÄ Deploy extracted files"
        shell: pwsh
        run: |
          $merged = "${{ steps.extract.outputs.merged_root }}"
          $destinationRoot = "C:\deploy_test\destination\httpdocs"
          $domains = "${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $deployType = "${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {
              Write-Host "`n‚û° Deploying to domain: $domain"

              $targets = @()
              $extractedFolders = Get-ChildItem -Path $merged -Directory

              foreach ($folder in $extractedFolders) {
                  # Determine target based on ZIP type
                  switch ($true) {
                      { $folder.Name -match "crew" }      { $dest = Join-Path $destinationRoot "CREW"; if ($deployType -eq "backend") { continue } }
                      { $folder.Name -match "v10|ag-app"} { $dest = Join-Path $destinationRoot "AG"; if ($deployType -eq "frontend") { continue } }
                      { $folder.Name -match "e-invoice" } { $dest = Join-Path $destinationRoot "EInvoice" }
                      { $folder.Name -match "e-statement"} { $dest = Join-Path $destinationRoot "EStatement" }
                      { $folder.Name -match "e-proposal"} { $dest = Join-Path $destinationRoot "EProposal" }
                      default { Write-Host "‚ö† Unknown folder: $($folder.Name), skipping..."; continue }
                  }

                  $targets += @{ Source = "$($folder.FullName)\*" ; Destination = $dest }
              }

              # Deploy all targets
              foreach ($target in $targets) {
                  Write-Host "üìÇ Deploying from $($target.Source) ‚Üí $($target.Destination)"
                  if (-not (Test-Path $target.Destination)) { New-Item -ItemType Directory -Path $target.Destination | Out-Null }
                  Copy-Item "$($target.Source)" $target.Destination -Recurse -Force
              }
          }

      # -----------------------------
      # 4Ô∏è‚É£ Cleanup temporary folders
      # -----------------------------
      - name: "üßπ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
