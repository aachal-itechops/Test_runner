name: "üöö Manual Local Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false

      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:

      - name: "üì• Checkout Repo"
        uses: actions/checkout@v4

      - name: "üì¶ Prepare Merge Folder from ZIPs"
        id: merge
        shell: pwsh
        run: |
          $root = "$PWD/deploy"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged = "$root/merged"
          New-Item -ItemType Directory -Path $merged | Out-Null

          $frontendMerged = "$merged/frontend"
          $backendMerged  = "$merged/backend"
          New-Item -ItemType Directory -Path $frontendMerged | Out-Null
          New-Item -ItemType Directory -Path $backendMerged  | Out-Null

          $frontendZip = "C:\deploy_test\frontend.zip"
          $backendZip  = "C:\deploy_test\backend.zip"

          if (Test-Path $frontendZip) {
              Expand-Archive $frontendZip -DestinationPath $frontendMerged -Force
          }
          if (Test-Path $backendZip) {
              Expand-Archive $backendZip -DestinationPath $backendMerged -Force
          }

          echo "merged_root=$merged" >> $env:GITHUB_OUTPUT


      - name: "üöÄ Deploy merged files using targets"
        shell: pwsh
        run: |
          $source="${{ steps.merge.outputs.merged_root }}"
          $domains="${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $type="${{ github.event.inputs.app_type }}"

          function Detect-AppFolder($folderPath) {
              $patterns = @{
                "AG"          = "AG"
                "Crew"        = "CREW"
                "Invoice"     = "E-Invoice"
                "Statement"   = "E-Statement"
                "Proposal"    = "E-Proposal"
              }

              foreach ($p in $patterns.Keys) {
                  if (Get-ChildItem -Path $folderPath -Recurse -Filter "*$p*" -ErrorAction SilentlyContinue) {
                      return $patterns[$p]
                  }
              }

              return "UNKNOWN"
          }

          foreach ($domain in $domains) {

            Write-Host "`n‚û° Deploying to $domain"

            # Local test destination
            $webroot = "C:\deploy_test\destination\httpdocs"

            $targets = @()

            switch ($type) {

              "frontend" {
                $targets += @{
                  Source = "$source\frontend"
                  Logical = "frontend"
                }
              }

              "backend" {
                $targets += @{
                  Source = "$source\backend"
                  Logical = "backend"
                }
              }

              "both" {
                $targets += @{ Source = "$source\frontend"; Logical = "frontend" }
                $targets += @{ Source = "$source\backend";  Logical = "backend"  }
              }

            }

            foreach ($target in $targets) {

              $top = Get-ChildItem -Path $target.Source -Directory

              foreach ($folder in $top) {

                $appName = Detect-AppFolder $folder.FullName

                if ($appName -eq "UNKNOWN") {
                  Write-Host "‚ö† Skipped (No App Detected): $($folder.FullName)"
                  continue
                }

                # AG frontend + AG backend both ‚Üí AG folder
                if ($appName -eq "AG" -or $appName -eq "CREW") {
                  $dest = Join-Path $webroot "AG"
                }
                else {
                  $dest = Join-Path $webroot $appName
                }

                if (!(Test-Path $dest)) {
                  New-Item -ItemType Directory -Path $dest -Force | Out-Null
                }

                Write-Host "üìÅ Deploying $appName ‚Üí $dest"
                Remove-Item "$dest\*" -Recurse -Force -ErrorAction SilentlyContinue
                Copy-Item "$($folder.FullName)\*" $dest -Recurse -Force
              }

            }
          }


      - name: "üßπ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
