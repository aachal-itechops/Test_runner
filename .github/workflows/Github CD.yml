name: "üöö Manual Backend Deploy (Local-Test-Friendly)"

on:
  workflow_dispatch:
    inputs:
      host:
        description: "Select target host / runner"
        required: true
        type: choice
        options:
          - host24-backend
          - host24-frontend
          - host24-zip
          - AWS_Staging
          - AWS_PROD_01
          - AWS_PROD_02
          - AWS_PROD_03
          - AWS_PROD_04
          - AWS_PROD_05
          - test_runner

      domain:
        description: "Comma-separated domain(s). Required."
        required: false

      exclude_domains:
        description: "Comma-separated domains to exclude manually"
        required: false

      restart_iis:
        description: "Restart IIS before & after Deployment?"
        required: false
        type: boolean

      app_type:
        description: "Deployment Type (backend -> AG, frontend -> httpdocs, both)"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both

      release_tag:
        description: "GitHub Release tag (e.g., release/V10.0.3)"
        required: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:

      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è Ensure GH CLI Installed"
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "üì¶ Installing GitHub CLI (ZIP fallback)..."
            $version = "2.56.0"
            $url = "https://github.com/cli/cli/releases/download/v$version/gh_${version}_windows_amd64.zip"
            $zip = "$env:TEMP\ghcli.zip"
            $dest = "$env:ProgramData\ghcli"

            if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }

            Invoke-WebRequest -Uri $url -OutFile $zip
            Expand-Archive $zip $dest -Force

            $exe = Get-ChildItem $dest -Recurse -Filter gh.exe | Select-Object -First 1
            echo $exe.DirectoryName | Out-File $env:GITHUB_PATH -Append
          }

      - name: "üßæ Download ZIP Assets from GitHub Release (or create dummy)"
        id: download
        shell: pwsh
        run: |
          $tag="${{ github.event.inputs.release_tag }}"

          $downloadDir="$PWD/release_zips"
          if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
          New-Item -ItemType Directory -Path $downloadDir | Out-Null

          if (-not $tag) {
            Write-Host "‚ö†Ô∏è No release tag provided, creating dummy ZIP for testing"
            New-Item -ItemType File -Path "$downloadDir/dummy.txt" | Out-Null
          } elseif (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "‚ö†Ô∏è GH CLI not available, skipping download, creating dummy ZIP"
            New-Item -ItemType File -Path "$downloadDir/dummy.txt" | Out-Null
          } else {
            gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --clobber
            Move-Item *.zip $downloadDir -Force
            $count = (Get-ChildItem $downloadDir "*.zip").Count
            if ($count -eq 0) { Write-Host "‚ö†Ô∏è No ZIPs found, creating dummy"; New-Item -ItemType File -Path "$downloadDir/dummy.txt" | Out-Null }
          }

          echo "download_dir=$downloadDir" >> $env:GITHUB_OUTPUT

      - name: "üì¶ Extract and Merge ZIPs"
        id: extract
        shell: pwsh
        run: |
          $src="${{ steps.download.outputs.download_dir }}"
          $root="$PWD/deploy"

          if (Test-Path $root) { Remove-Item -Recurse -Force $root }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged=Join-Path $root "merged"
          New-Item -ItemType Directory $merged | Out-Null

          foreach ($zip in Get-ChildItem $src "*.zip") {
            $tmp=Join-Path $root $zip.BaseName
            Expand-Archive $zip.FullName $tmp -Force

            Get-ChildItem $tmp | ForEach-Object {
              Copy-Item $_.FullName -Destination $merged -Recurse -Force
            }
          }

          echo "extract_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "üöÄ Deploy to Domain(s) (IIS Skipped if Missing)"
        id: deploy
        shell: pwsh
        run: |
          $rawDomains="${{ github.event.inputs.domain }}"
          $rawExclude="${{ github.event.inputs.exclude_domains }}"
          $restart="${{ github.event.inputs.restart_iis }}"
          $type="${{ github.event.inputs.app_type }}"
          $source="${{ steps.extract.outputs.extract_root }}"

          $success=@()
          $failed=@()

          if ([string]::IsNullOrWhiteSpace($rawDomains)) {
            Write-Host "‚ö†Ô∏è No domain provided, skipping deploy."
            exit 0
          }

          $domains=$rawDomains.Split(",") | ForEach-Object { $_.Trim() }

          if (-not [string]::IsNullOrWhiteSpace($rawExclude)) {
            $exclude=$rawExclude.Split(",") | ForEach-Object { $_.Trim() }
            $domains=$domains | Where-Object { $exclude -notcontains $_ }
          }

          if ($domains.Count -eq 0) {
            Write-Host "‚ö†Ô∏è No domains left after exclude."
            exit 0
          }

          Write-Host "üîπ Deploy to: $($domains -join ', ')"

          foreach ($domain in $domains) {
            Write-Host "`n===================================="
            Write-Host "üöö Deploying to $domain"
            Write-Host "====================================`n"

            $targets=@()
            switch ($type) {
              "frontend" { $targets+="D:\inetpub\vhosts\$domain\httpdocs" }
              "backend"  { $targets+="D:\inetpub\vhosts\$domain\httpdocs\AG" }
              "both"     { 
                $targets+="D:\inetpub\vhosts\$domain\httpdocs"
                $targets+="D:\inetpub\vhosts\$domain\httpdocs\AG"
              }
            }

            foreach ($target in $targets) {
              Write-Host "üìÇ Deploying to $target"
              if (-not (Test-Path $target)) { New-Item -ItemType Directory -Path $target -Force | Out-Null }
              Write-Host "üöö Copying files..."
              Copy-Item "$source\*" $target -Recurse -Force -ErrorAction SilentlyContinue
            }

            if (Get-Module -ListAvailable -Name WebAdministration) {
              Import-Module WebAdministration
              if ($restart -eq "true" -and (Test-Path "IIS:\AppPools\$domain")) {
                Stop-WebAppPool $domain
                Start-WebAppPool $domain
              }
            } else {
              Write-Host "‚ö†Ô∏è WebAdministration not available, skipping IIS restart"
            }

            $success+=$domain
          }

          Write-Host "`nüìÑ Summary:"
          Write-Host "Successful: $($success -join ', ')"
          Write-Host "Failed: $($failed -join ', ')"

      - name: "üßπ Cleanup workspace"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "üßπ Cleanup completed."
