name: "üöö Manual Backend Deploy (from Release ZIP)"

on:
  workflow_dispatch:
    inputs:
      host:
        description: "Select target host / runner"
        required: true
        type: choice
        options:
          - host24-backend
          - host24-frontend
          - host24-zip
          - AWS_Staging
          - AWS_PROD_01
          - AWS_PROD_02
          - AWS_PROD_03
          - AWS_PROD_04
          - AWS_PROD_05

      domain:
        description: "Comma-separated domain(s)"
        required: true

      exclude_domains:
        description: "Comma-separated domains to exclude manually"
        required: false

      restart_iis:
        description: "Restart IIS before & after Deployment?"
        required: false
        type: boolean

      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both

      release_tag:
        description: "GitHub Release tag (e.g., release/V10.0.3)"
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ${{ fromJson('{
      "host24-backend":["self-hosted","Windows","X64","host24","backend"],
      "host24-frontend":["self-hosted","Windows","X64","host24","frontend"],
      "host24-zip":["self-hosted","Windows","X64","host24","zip"],
      "AWS_Staging":["self-hosted","Windows","X64","AWS_Staging"],
      "AWS_PROD_01":["self-hosted","Windows","X64","AWS_PROD_01"],
      "AWS_PROD_02":["self-hosted","Windows","X64","AWS_PROD_02"],
      "AWS_PROD_03":["self-hosted","Windows","X64","AWS_PROD_03"],
      "AWS_PROD_04":["self-hosted","Windows","X64","AWS_PROD_04"],
      "AWS_PROD_05":["self-hosted","Windows","X64","AWS_PROD_05"]
      }')[github.event.inputs.host] }}

    steps:

      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è Install GitHub CLI if Missing"
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "üì¶ Installing GitHub CLI‚Ä¶"
            $ver = "2.56.0"
            $url = "https://github.com/cli/cli/releases/download/v$ver/gh_${ver}_windows_amd64.zip"
            $zip = "$env:TEMP\ghcli.zip"
            $dest = "$env:ProgramData\ghcli"

            if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
            Invoke-WebRequest $url -OutFile $zip
            Expand-Archive $zip $dest -Force

            $exe = Get-ChildItem $dest -Recurse -Filter gh.exe | Select-Object -First 1
            echo $exe.DirectoryName | Out-File $env:GITHUB_PATH -Append
            & "$($exe.FullName)" --version
          }

      - name: "üì• Download Release ZIP Assets"
        id: download
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag="${{ github.event.inputs.release_tag }}"
          Write-Host "Downloading Release ZIPs for $tag‚Ä¶"
          gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --clobber

          $dl="$PWD/release_zips"
          if (Test-Path $dl) { Remove-Item -Force -Recurse $dl }
          New-Item -ItemType Directory -Path $dl | Out-Null

          Move-Item *.zip $dl -Force
          echo "download_dir=$dl" >> $env:GITHUB_OUTPUT

      - name: "üì¶ Extract ZIPs & Merge"
        id: extract
        shell: pwsh
        run: |
          $src="${{ steps.download.outputs.download_dir }}"
          $root="$PWD/deploy"
          $merged="$root\merged"

          if (Test-Path $root) { Remove-Item -Recurse -Force $root }
          New-Item -ItemType Directory -Path $merged | Out-Null

          foreach ($zip in Get-ChildItem $src "*.zip") {
            $tmp="$root\$($zip.BaseName)"
            Expand-Archive $zip.FullName $tmp -Force
            Copy-Item "$tmp\*" $merged -Recurse -Force
          }

          echo "extract_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "üöÄ Deploy to Domain(s)"
        shell: pwsh
        run: |
          Import-Module WebAdministration

          $domains = "${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $excludeInput = "${{ github.event.inputs.exclude_domains }}"
          $restart = "${{ github.event.inputs.restart_iis }}"
          $type = "${{ github.event.inputs.app_type }}"
          $source = "${{ steps.extract.outputs.extract_root }}"

          if ($excludeInput) {
            $exclude = $excludeInput.Split(",") | ForEach-Object { $_.Trim() }
            $domains = $domains | Where-Object { $exclude -notcontains $_ }
          }

          # detect frontend/backend in ZIP
          $hasBackend = Test-Path "$source\AG"
          $hasFrontend = Test-Path "$source\index.html" -or
                         Test-Path "$source\dist" -or
                         Test-Path "$source\build"

          foreach ($domain in $domains) {

            Write-Host "`n===== Deploying $domain ====="

            # determine correct target folder(s)
            switch ($type) {
              "frontend" {
                if (-not $hasFrontend) { Write-Host "‚ö†Ô∏è No frontend files detected"; continue }
                $targets = @("D:\inetpub\vhosts\$domain\httpdocs")
              }

              "backend" {
                if (-not $hasBackend) { Write-Host "‚ö†Ô∏è No backend/AG folder detected"; continue }
                $targets = @("D:\inetpub\vhosts\$domain\httpdocs\AG")
              }

              "both" {
                $targets=@()
                if ($hasFrontend) { $targets += "D:\inetpub\vhosts\$domain\httpdocs" }
                if ($hasBackend)  { $targets += "D:\inetpub\vhosts\$domain\httpdocs\AG" }
              }
            }

            $pool = $domain

            # Stop AppPool
            if ($restart -eq "true" -and (Test-Path "IIS:\AppPools\$pool")) {
              Stop-WebAppPool $pool
            }

            foreach ($target in $targets) {
              Write-Host "üìÇ Deploying to $target"

              if (-not (Test-Path $target)) {
                New-Item -ItemType Directory -Force -Path $target
              }

              Copy-Item "$source\*" $target -Recurse -Force -ErrorAction Stop
            }

            # Start AppPool
            if (Test-Path "IIS:\AppPools\$pool") { Start-WebAppPool $pool }
          }

          if ($restart -eq "true") {
            Write-Host "üîÑ Full IIS Restart"
            iisreset /restart
          }

      - name: "üßπ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Cleanup complete."
