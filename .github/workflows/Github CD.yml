name: "üöö Manual Backend Deploy (from Release ZIP)"

on:
  workflow_dispatch:
    inputs:
      host:
        description: "Select target host / runner"
        required: true
        type: choice
        options:
          - host24-backend
          - host24-frontend
          - host24-zip
          - AWS_Staging
          - AWS_PROD_01
          - AWS_PROD_02
          - AWS_PROD_03
          - AWS_PROD_04
          - AWS_PROD_05
          - test_runner

      domain:
        description: "Comma-separated domain(s). Required."
        required: false

      exclude_domains:
        description: "Comma-separated domains to exclude manually"
        required: false

      restart_iis:
        description: "Restart IIS before & after Deployment?"
        required: false
        type: boolean

      app_type:
        description: "Deployment Type (backend -> AG, frontend -> httpdocs, both)"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both

      release_tag:
        description: "GitHub Release tag (e.g., release/V10.0.3)"
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:

      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è Ensure GitHub CLI Installed (ZIP fallback)"
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "üì¶ Installing GitHub CLI (ZIP fallback)..."
            $version = "2.56.0"
            $url = "https://github.com/cli/cli/releases/download/v$version/gh_${version}_windows_amd64.zip"
            $zip = "$env:TEMP\ghcli.zip"
            $dest = "$env:ProgramData\ghcli"

            if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }

            Invoke-WebRequest -Uri $url -OutFile $zip
            Expand-Archive $zip $dest -Force

            $exe = Get-ChildItem $dest -Recurse -Filter gh.exe | Select-Object -First 1
            if (-not $exe) { Write-Error "‚ùå gh.exe missing"; exit 1 }

            echo $exe.DirectoryName | Out-File $env:GITHUB_PATH -Append
            & "$($exe.FullName)" --version
          } else {
            Write-Host "‚úÖ GH CLI exists: $(gh --version | Select-String 'gh version')"
          }

      - name: "üßæ Download ZIP Assets from GitHub Release"
        id: download
        shell: pwsh
        #env:
          #GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag="${{ github.event.inputs.release_tag }}"
          Write-Host "üì• Downloading Release ZIPs for $tag..."
          gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --clobber

          $downloadDir="$PWD/release_zips"
          if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
          New-Item -ItemType Directory -Path $downloadDir | Out-Null

          Move-Item *.zip $downloadDir -Force
          $count=(Get-ChildItem $downloadDir "*.zip").Count
          if ($count -eq 0) { Write-Error "‚ùå No ZIP files found"; exit 1 }

          echo "download_dir=$downloadDir" >> $env:GITHUB_OUTPUT

      - name: "üì¶ Extract and Merge ZIPs"
        id: extract
        shell: pwsh
        run: |
          $src="${{ steps.download.outputs.download_dir }}"
          $root="$PWD/deploy"

          if (Test-Path $root) { Remove-Item -Recurse -Force $root }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged=Join-Path $root "merged"
          New-Item -ItemType Directory $merged | Out-Null

          foreach ($zip in Get-ChildItem $src "*.zip") {
            $tmp=Join-Path $root $zip.BaseName
            Expand-Archive $zip.FullName $tmp -Force

            Get-ChildItem $tmp | ForEach-Object {
              Copy-Item $_.FullName -Destination $merged -Recurse -Force
            }
          }

          echo "extract_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "üöÄ Deploy to Domain(s)"
        id: deploy
        shell: pwsh
        run: |
          Import-Module WebAdministration

          $rawDomains="${{ github.event.inputs.domain }}"
          $rawExclude="${{ github.event.inputs.exclude_domains }}"
          $restart="${{ github.event.inputs.restart_iis }}"
          $type="${{ github.event.inputs.app_type }}"
          $source="${{ steps.extract.outputs.extract_root }}"

          $success=@()
          $failed=@()

          if ([string]::IsNullOrWhiteSpace($rawDomains)) {
            Write-Host "‚ùå ERROR: No domain provided."
            exit 0
          }

          $domains=$rawDomains.Split(",") | ForEach-Object { $_.Trim() }

          if (-not [string]::IsNullOrWhiteSpace($rawExclude)) {
            $exclude=$rawExclude.Split(",") | ForEach-Object { $_.Trim() }
            Write-Host "üö´ Manual Exclude: $($exclude -join ', ')"
            $domains=$domains | Where-Object { $exclude -notcontains $_ }
          }

          if ($domains.Count -eq 0) {
            Write-Host "‚ö†Ô∏è No domains left after manual exclude!"
            exit 0
          }

          Write-Host "üîπ Deploy to: $($domains -join ', ')"

          foreach ($domain in $domains) {

            Write-Host "`n===================================="
            Write-Host "üöÄ Deploying to $domain"
            Write-Host "====================================`n"

            $pool=$domain

            if ($restart -eq "true") {
              if (Test-Path "IIS:\AppPools\$pool") {
                Stop-WebAppPool $pool
              }
            }

            try {
              $targets=@()

              switch ($type) {
                "frontend" { 
                  $targets+="D:\inetpub\vhosts\$domain\httpdocs" 
                }
                "backend"  { 
                  $targets+="D:\inetpub\vhosts\$domain\httpdocs\AG" 
                }
                "both"     {
                  $targets+="D:\inetpub\vhosts\$domain\httpdocs"
                  $targets+="D:\inetpub\vhosts\$domain\httpdocs\AG"
                }
              }

              foreach ($target in $targets) {
                Write-Host "üìÇ Deploying to $target"

                if (-not (Test-Path $target)) {
                  New-Item -ItemType Directory -Path $target -Force | Out-Null
                }

                Write-Host "üöö Copying..."
                Copy-Item "$source\*" $target -Recurse -Force -ErrorAction Stop
              }

              if (Test-Path "IIS:\AppPools\$pool") {
                Start-WebAppPool $pool
              }

              $success+=$domain
            }
            catch {
              Write-Host "‚ùå ERROR deploying to $domain"
              $failed+=$domain

              if (Test-Path "IIS:\AppPools\$pool") {
                Start-WebAppPool $pool
              }
            }

            if ($restart -eq "true") {
              if (Test-Path "IIS:\AppPools\$pool") {
                Start-WebAppPool $pool
              }
            }
          }

          if ($restart -eq "true") {
            Write-Host "üîÑ Restarting IIS globally..."
            iisreset /restart
          }

          Write-Host "`nüìÑ Summary:"
          Write-Host "Successful: $($success -join ', ')"
          Write-Host "Failed: $($failed -join ', ')"

      - name: "üßπ Cleanup workspace"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "üßπ Cleanup completed."
