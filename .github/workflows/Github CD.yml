name: "ðŸšš Manual Local Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false

      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: "ðŸ“¥ Checkout Repo"
        uses: actions/checkout@v4

      - name: "ðŸ“¦ Prepare Deploy Folder"
        id: merge
        shell: pwsh
        run: |
          $root = "$PWD/deploy"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null
          echo "merged_root=$root" >> $env:GITHUB_OUTPUT

      - name: "ðŸš€ Deploy ZIPs to Local Destination"
        shell: pwsh
        run: |
          $sourceFolder = "C:\deploy_test\source"
          $destinationRoot = "C:\deploy_test\destination\httpdocs"
          $domains = "${{ github.event.inputs.domain }}".Split(",") | ForEach-Object { $_.Trim() }
          $deployType = "${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {
              Write-Host "`nâž¡ Deploying to domain: $domain"

              $zipFiles = Get-ChildItem -Path $sourceFolder -Filter *.zip*
              $targets = @()

              foreach ($zip in $zipFiles) {
                  # Extract ZIP
                  $temp = Join-Path $sourceFolder "extract_$((Get-Random))"
                  New-Item -ItemType Directory -Path $temp | Out-Null
                  Write-Host "ðŸŸ© Extracting $($zip.Name)"
                  Expand-Archive -LiteralPath $zip.FullName -DestinationPath $temp -Force

                  # Detect content-based deployment
                  $subFolders = Get-ChildItem -Path $temp -Directory
                  foreach ($folder in $subFolders) {
                      $dest = $null

                      # AG backend folder detection
                      if (Get-ChildItem $folder.FullName -Recurse | Where-Object { $_.Name -match "ag-app|v10" }) {
                          $dest = Join-Path $destinationRoot "AG"
                          if ($deployType -eq "frontend") { continue }
                      }
                      # CREW frontend
                      elseif ($folder.Name -match "crew") { 
                          $dest = Join-Path $destinationRoot "CREW"
                          if ($deployType -eq "backend") { continue }
                      }
                      # Other frontend apps
                      elseif ($folder.Name -match "e-invoice") { $dest = Join-Path $destinationRoot "EInvoice" }
                      elseif ($folder.Name -match "e-statement") { $dest = Join-Path $destinationRoot "EStatement" }
                      elseif ($folder.Name -match "e-proposal") { $dest = Join-Path $destinationRoot "EProposal" }

                      if ($dest) {
                          $targets += @{ Source = "$($folder.FullName)\*" ; Destination = $dest }
                      } else {
                          Write-Host "âš  Skipping unknown folder: $($folder.Name)"
                      }
                  }

                  # Cleanup extracted temp folder
                  Remove-Item $temp -Recurse -Force
              }

              # Deploy all targets
              foreach ($target in $targets) {
                  Write-Host "ðŸ“‚ Deploying from $($target.Source) â†’ $($target.Destination)"
                  if (-not (Test-Path $target.Destination)) { New-Item -ItemType Directory -Path $target.Destination | Out-Null }
                  Copy-Item "$($target.Source)" $target.Destination -Recurse -Force
              }
          }

      - name: "ðŸ§¹ Cleanup Deploy Folder"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
