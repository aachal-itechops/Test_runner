name: üöö Manual Deploy (Auto-Detect Apps)

on:
  workflow_dispatch:
    inputs:
      type:
        description: "What do you want to deploy?"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both
      domain:
        description: "Which domain?"
        required: false
        type: choice
        options:
          - domain1.com
          - domain2.com
          - domain3.com

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üü¶ Set variables
        run: |
          $source = "C:\Users\BAPS\actions-runner-testrunner\_work\Test_runner\Test_runner\deploy\merged"
          $deployType = "${{ github.event.inputs.type }}"
          $domain = "${{ github.event.inputs.domain }}"
          $webroot = "D:\inetpub\vhosts\$domain\httpdocs"

          Write-Host "Source = $source"
          Write-Host "Deploy type = $deployType"
          Write-Host "Domain = $domain"
          Write-Host "Webroot = $webroot"

      - name: üì¶ Process ZIP Files (Auto-Detect App)
        shell: pwsh
        run: |
          $source = "C:\Users\BAPS\actions-runner-testrunner\_work\Test_runner\Test_runner\deploy\merged"
          $deployType = "${{ github.event.inputs.type }}"
          $domain = "${{ github.event.inputs.domain }}"
          $webroot = "D:\inetpub\vhosts\$domain\httpdocs"

          function Detect-AppName($folderPath) {
              $names = @(
                "AG", "Crew", "E-Statement", "E-Invoice", "E-Proposal"
              )

              foreach ($n in $names) {
                if (Get-ChildItem -Path $folderPath -Recurse -Filter "*$n*" -ErrorAction SilentlyContinue) {
                  return $n
                }
              }

              return "UNKNOWN"
          }

          function Deploy-Folder($folder, $deployType) {
              $appName = Detect-AppName $folder.FullName
              if ($appName -eq "UNKNOWN") {
                Write-Host "‚ö† No matching app name detected for $($folder.Name)"
                return
              }

              $dest = Join-Path $webroot $appName
              if (!(Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }

              Write-Host "üìÅ Detected App: $appName"
              Write-Host "‚û° Copying to $dest"

              Remove-Item "$dest\*" -Recurse -Force -ErrorAction SilentlyContinue
              Copy-Item -Path "$($folder.FullName)\*" -Destination $dest -Recurse -Force
          }

          # Process only allowed types
          $zipFiles = Get-ChildItem -Path $source -Filter *.zip

          foreach ($zip in $zipFiles) {

            $temp = Join-Path $source "extract_$((Get-Random))"
            New-Item -ItemType Directory -Path $temp | Out-Null

            Write-Host "üü© Extracting $($zip.Name)"
            Expand-Archive -LiteralPath $zip.FullName -DestinationPath $temp -Force

            $topFolders = Get-ChildItem -Path $temp -Directory

            foreach ($folder in $topFolders) {
              Deploy-Folder -folder $folder -deployType $deployType
            }

            Remove-Item $temp -Recurse -Force
          }
