name: "ðŸšš Manual Local Deploy Test"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Comma-separated domains"
        required: false

      app_type:
        description: "Deployment Type"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: "ðŸ“¥ Checkout Repo"
        uses: actions/checkout@v4

      # ------------------------------------------
      # 1. PREPARE MERGED FOLDER
      # ------------------------------------------
      - name: "ðŸ“¦ Prepare Merge Folder from ZIPs"
        id: merge
        shell: pwsh
        run: |
          $root = "$PWD/deploy"
          if (Test-Path $root) { Remove-Item $root -Recurse -Force }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged = "$root/merged"
          New-Item -ItemType Directory -Path $merged | Out-Null

          $frontendMerged = "$merged/frontend"
          $backendMerged  = "$merged/backend"

          New-Item -ItemType Directory -Path $frontendMerged | Out-Null
          New-Item -ItemType Directory -Path $backendMerged  | Out-Null

          $sourceFolder = "C:\deploy_test\source"

          # ---- FRONTEND ZIP (CREW) ----
          $frontendZip = Get-ChildItem $sourceFolder -Filter "*crew*.zip" | Select-Object -First 1
          if ($frontendZip) {
            Write-Host "ðŸ“¦ Extracting FRONTEND: $($frontendZip.Name)"
            Expand-Archive $frontendZip.FullName -DestinationPath $frontendMerged -Force
          } else {
            Write-Warning "âš ï¸ FRONTEND ZIP NOT FOUND (crew)"
          }

          # ---- BACKEND ZIP (AG APP) ----
          $backendZip = Get-ChildItem $sourceFolder -Filter "*ag-app*.zip" | Select-Object -First 1
          if ($backendZip) {
            Write-Host "ðŸ“¦ Extracting BACKEND: $($backendZip.Name)"
            Expand-Archive $backendZip.FullName -DestinationPath $backendMerged -Force
          } else {
            Write-Warning "âš ï¸ BACKEND ZIP NOT FOUND (ag-app)"
          }

          echo "merged_root=$merged" >> $env:GITHUB_OUTPUT

      # ------------------------------------------
      # 2. DEPLOYMENT LOGIC
      # ------------------------------------------
      - name: "ðŸš€ Deploy merged files"
        shell: pwsh
        run: |
          $source  = "${{ steps.merge.outputs.merged_root }}"
          $domains = "${{ github.event.inputs.domain }}"

          if (-not $domains) {
            $domains = @("local-test")
          } else {
            $domains = $domains.Split(",") | ForEach-Object { $_.Trim() }
          }

          $type = "${{ github.event.inputs.app_type }}"

          foreach ($domain in $domains) {

            Write-Host "âž¡ Deploying for: $domain"

            $targets = @()

            switch ($type) {

              "frontend" {
                $targets += @{
                  Source      = "$source\frontend"
                  Destination = "C:\deploy_test\destination\httpdocs\CREW"
                }
              }

              "backend" {
                $targets += @{
                  Source      = "$source\backend"
                  Destination = "C:\deploy_test\destination\httpdocs\AG"
                }
              }

              "both" {
                $targets += @{
                  Source      = "$source\frontend"
                  Destination = "C:\deploy_test\destination\httpdocs\CREW"
                }
                $targets += @{
                  Source      = "$source\backend"
                  Destination = "C:\deploy_test\destination\httpdocs\AG"
                }
              }
            }

            foreach ($target in $targets) {
              Write-Host "ðŸ“‚ Deploying from $($target.Source) â†’ $($target.Destination)"

              if (-not (Test-Path $target.Destination)) {
                New-Item -ItemType Directory -Path $target.Destination -Force | Out-Null
              }

              Copy-Item "$($target.Source)\*" $target.Destination -Recurse -Force
            }
          }

      # ------------------------------------------
      # 3. CLEANUP TEMP FOLDER
      # ------------------------------------------
      - name: "ðŸ§¹ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
